<!doctype html>
<html lang="en">
<%- include('partials/head') %>
<body>
  <%- include('partials/topbar') %>

  <main class="container">
    <section class="card">
      <h1><%= monitor.name %></h1>
      <p class="meta"><strong>Type:</strong> <%= (monitor.monitor_type || 'http').toUpperCase() %></p>
      <p class="meta"><%= monitor.url %></p>
      <p class="meta">Last <%= rows.length %> checks uptime: <strong><%= uptimePercent %>%</strong></p>
      <div id="chart" class="chart"></div>
    </section>

    <section class="card">
      <h2>Incidents</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Status</th>
              <th>Code</th>
              <th>Response</th>
            </tr>
          </thead>
          <tbody>
            <% if (limitedIncidents.length === 0) { %>
              <tr><td colspan="4">No incidents recorded.</td></tr>
            <% } %>
            <% limitedIncidents.forEach((r) => { %>
              <tr>
                <td><%= r.checked_at %></td>
                <td><span class="badge <%= r.status === 'UP' ? 'up' : 'down' %>"><%= r.status %></span></td>
                <td><%= r.status_code ?? 'N/A' %></td>
                <td><%= r.response_time ?? 'N/A' %>ms</td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Monitor Metadata</h2>
      <ul class="meta-list">
        <li><strong>Current Status:</strong> <span class="badge <%= latest && latest.status === 'UP' ? 'up' : (latest && latest.status === 'DOWN' ? 'down' : 'unknown') %>"><%= latest ? latest.status : 'UNKNOWN' %></span></li>
        <li><strong>Current Date:</strong> <%= new Date(metadata.currentDate).toLocaleString() %></li>
        <li><strong>Last Update:</strong> <%= metadata.lastUpdate === 'Never' ? 'Never' : new Date(metadata.lastUpdate).toLocaleString() %></li>
        <li><strong>Next Update:</strong> <%= metadata.nextUpdate === 'Unknown' ? 'Unknown' : new Date(metadata.nextUpdate).toLocaleString() %></li>
      </ul>
    </section>
  </main>

  <script src="/vendor/echarts/echarts.min.js"></script>
  <script nonce="<%= nonce %>">
    const points = <%- JSON.stringify(points) %>;
    const chartEl = document.getElementById('chart');

    if (!points.length || typeof echarts === 'undefined') {
      chartEl.innerHTML = '<p class="empty-chart">No data yet. Wait for checks to run.</p>';
    } else {
      const sorted = points.slice().sort((a, b) => new Date(a.time) - new Date(b.time));
      const labels = sorted.map((point) => new Date(point.time).toLocaleTimeString());
      const statusSeries = sorted.map((point) => point.value);
      const responseSeries = sorted.map((point) => point.responseTime ?? null);
      const chart = echarts.init(chartEl);

      chart.setOption({
        backgroundColor: 'transparent',
        grid: { left: 40, right: 30, top: 30, bottom: 30 },
        tooltip: {
          trigger: 'axis',
          valueFormatter: (value) => (value === null ? 'N/A' : value),
        },
        legend: {
          data: ['Status', 'Response (ms)'],
          textStyle: { color: '#8b949e' },
          top: 0,
        },
        xAxis: {
          type: 'category',
          data: labels,
          axisLabel: { color: '#8b949e', hideOverlap: true },
          axisLine: { lineStyle: { color: '#30363d' } },
        },
        yAxis: [
          {
            type: 'value',
            min: 0,
            max: 1,
            interval: 1,
            axisLabel: {
              color: '#8b949e',
              formatter: (val) => (val === 1 ? 'UP' : 'DOWN'),
            },
            splitLine: { lineStyle: { color: '#30363d' } },
          },
          {
            type: 'value',
            axisLabel: { color: '#8b949e' },
            splitLine: { show: false },
          },
        ],
        series: [
          {
            name: 'Status',
            type: 'line',
            step: 'end',
            yAxisIndex: 0,
            data: statusSeries,
            symbol: 'none',
            lineStyle: { width: 2, color: '#00ff88' },
          },
          {
            name: 'Response (ms)',
            type: 'line',
            smooth: true,
            yAxisIndex: 1,
            data: responseSeries,
            symbol: 'none',
            lineStyle: { width: 2, color: '#1f6feb' },
          },
        ],
      });

      window.addEventListener('resize', () => chart.resize());
    }
  </script>
</body>
</html>
